-- Make NextQuestID work by using the proper field
UPDATE quest_template SET nextquestidchain = nextquestid WHERE nextquestid > 0 AND nextquestidchain = 0;

-- Remove flag auto accept and add auto take where prevquestid is not null and quest has autoaccept and not autotake ans which is not bonus objective quest
UPDATE quest_template SET flags = flags & ~0x00080000, flags = flags | 0x00200000 WHERE prevquestid != 0 AND flags & 0x00080000 AND NOT flags & 0x00200000 AND id NOT IN (34504, 34076, 34496, 34728, 36590, 36660, 35649, 36792, 34505, 34501, 33145, 36603, 36571, 36563, 36480, 36476, 35881, 34724, 36504, 36566, 36564, 36473, 36500, 35379, 34723, 37280, 34639, 34667, 35237, 35236, 34660, 37421, 37422);

-- Remove flag autoaccept from quest which aren't bonus objective quests
UPDATE quest_template SET flags = flags & ~0x00080000 WHERE id NOT IN (34504, 34076, 34496, 34728, 36590, 36660, 35649, 36792, 34505, 34501, 33145, 36603, 36571, 36563, 36480, 36476, 35881, 34724, 36504, 36566, 36564, 36473, 36500, 35379, 34723, 37280, 34639, 34667, 35237, 35236, 34660, 37421, 37422);

-- Remove useless flags (autocomplete) for objective bonus quests
UPDATE quest_template SET flags = flags & ~0x00100000 WHERE id IN (34504, 34076, 34496, 34728, 36590, 36660, 35649, 36792, 34505, 34501, 33145, 36603, 36571, 36563, 36480, 36476, 35881, 34724, 36504, 36566, 36564, 36473, 36500, 35379, 34723, 37280, 34639, 34667, 35237, 35236, 34660, 37421, 37422);

-- fix pandaren quests broken next to the changes
UPDATE quest_template SET flags = flags | 0x00200000 WHERE id IN (29408, 29409, 29410, 29679, 29680, 29770);

-- invert flags autosubmit and autocomplete (wrongly handled until now) (ayayay)
UPDATE 
  quest_template 
SET
  flags = flags & ~0x100000,
  flags = flags | 0x10000 
WHERE id IN (
863,
9309,
9663,
11288,
11345,
12312,
13624,
13626,
13884,
13928,
13980,
14001,
14031,
14071,
14109,
14110,
14113,
14120,
14121,
14153,
14236,
14240,
14242,
14243,
14244,
14296,
14303,
14308,
14408,
14466,
14474,
14482,
24503,
24671,
24868,
24897,
24901,
24913,
24924,
24952,
24958,
24960,
24993,
25024,
25046,
25100,
25115,
25122,
25125,
25202,
25203,
25213,
25218,
25236,
25251,
25265,
25332,
25446,
25488,
25489,
25499,
25515,
25516,
25525,
25531,
25537,
25542,
25543,
25544,
25547,
25560,
25575,
25593,
25626,
25637,
25672,
25728,
25755,
25760,
25860,
25863,
25872,
25880,
25891,
25898,
25915,
25931,
25948,
25949,
25957,
25966,
25972,
25987,
25988,
26003,
26010,
26017,
26028,
26088,
26124,
26135,
26140,
26143,
26181,
26182,
26197,
26199,
26202,
26203,
26205,
26206,
26219,
26221,
26290,
26312,
26322,
26391,
26413,
26507,
26549,
26581,
26591,
26608,
26651,
26668,
26714,
26727,
26731,
26752,
26760,
26800,
26801,
26953,
26954,
26955,
26966,
26971,
26997,
27038,
27045,
27069,
27098,
27116,
27141,
27144,
27205,
27226,
27290,
27316,
27317,
27321,
27325,
27326,
27360,
27379,
27380,
27406,
27423,
27438,
27448,
27449,
27472,
27517,
27541,
27549,
27594,
27601,
27702,
27703,
27713,
27714,
27715,
27719,
27744,
27779,
27784,
27786,
27787,
27788,
27798,
27804,
27826,
27828,
27832,
27834,
27835,
27889,
27891,
27892,
27893,
27897,
27905,
27914,
28034,
28051,
28086,
28092,
28096,
28108,
28112,
28114,
28138,
28146,
28155,
28169,
28171,
28184,
28192,
28237,
28245,
28254,
28269,
28274,
28276,
28278,
28310,
28312,
28314,
28315,
28316,
28317,
28318,
28319,
28320,
28321,
28322,
28326,
28345,
28348,
28375,
28390,
28404,
28414,
28426,
28427,
28433,
28439,
28442,
28444,
28446,
28447,
28448,
28449,
28450,
28451,
28452,
28454,
28455,
28456,
28482,
28501,
28506,
28536,
28584,
28590,
28597,
28598,
28599,
28600,
28601,
28608,
28612,
28613,
28616,
28617,
28622,
28633,
28654,
28728,
28733,
28741,
28744,
28747,
28748,
28751,
28752,
28790,
28806,
28807,
28808,
28809,
28810,
28811,
28812,
28813,
28869,
29038,
29039,
29044,
29060,
29082,
29094,
29103,
29110,
29114,
29116,
29118,
29128,
29131,
29143,
29152,
29177,
29189,
29192,
29194,
29195,
29198,
29204,
29205,
29206,
29210,
29221,
29226,
29228,
29229,
29235,
29245,
29246,
29247,
29250,
29257,
29259,
29260,
29263,
29278,
29299,
29302,
29328,
29329,
29401,
29407,
29408,
29410,
29412,
29414,
29422,
29423,
29524,
29550,
29552,
29555,
29561,
29562,
29577,
29612,
29621,
29623,
29638,
29639,
29646,
29647,
29663,
29664,
29678,
29679,
29680,
29693,
29694,
29716,
29719,
29720,
29722,
29724,
29725,
29726,
29727,
29729,
29730,
29731,
29733,
29755,
29759,
29776,
29784,
29786,
29787,
29790,
29792,
29798,
29799,
29802,
29804,
29815,
29819,
29823,
29824,
29827,
29847,
29858,
29877,
29879,
29890,
29894,
29898,
29899,
29900,
29904,
29905,
29906,
29907,
29911,
29912,
29915,
29918,
29929,
29936,
29943,
29949,
29950,
29966,
29967,
29968,
29981,
29983,
30000,
30031,
30046,
30047,
30050,
30052,
30054,
30067,
30068,
30073,
30074,
30075,
30076,
30077,
30079,
30086,
30092,
30093,
30106,
30109,
30118,
30120,
30121,
30128,
30129,
30142,
30144,
30150,
30151,
30153,
30172,
30179,
30180,
30186,
30187,
30205,
30235,
30236,
30240,
30242,
30252,
30254,
30256,
30257,
30271,
30274,
30277,
30280,
30341,
30345,
30348,
30351,
30363,
30445,
30465,
30466,
30488,
30491,
30492,
30495,
30504,
30512,
30513,
30524,
30589,
30603,
30605,
30610,
30614,
30617,
30625,
30638,
30641,
30644,
30646,
30673,
30677,
30680,
30681,
30683,
30684,
30690,
30731,
30736,
30738,
30750,
30752,
30753,
30765,
30768,
30769,
30770,
30771,
30776,
30777,
30781,
30787,
30793,
30795,
30797,
30800,
30801,
30802,
30817,
30828,
30834,
30855,
30887,
30890,
30898,
30900,
30901,
30907,
30921,
30924,
30925,
30926,
30935,
30941,
30942,
30945,
30955,
30968,
30975,
30976,
30979,
30980,
30987,
30992,
30999,
31000,
31003,
31004,
31010,
31011,
31012,
31013,
31026,
31030,
31031,
31039,
31040,
31041,
31042,
31043,
31044,
31045,
31046,
31047,
31048,
31065,
31075,
31077,
31078,
31082,
31087,
31088,
31089,
31092,
31105,
31106,
31113,
31114,
31116,
31117,
31118,
31119,
31120,
31130,
31132,
31152,
31179,
31190,
31196,
31197,
31198,
31199,
31200,
31201,
31237,
31243,
31248,
31252,
31253,
31261,
31272,
31306,
31319,
31359,
31390,
31391,
31394,
31395,
31398,
31439,
31441,
31450,
31458,
31465,
31483,
31492,
31539,
31541,
31542,
31543,
31544,
31606,
31656,
31679,
31682,
31691,
31692,
31697,
31716,
31733,
31739,
31758,
31766,
31767,
31768,
31770,
31772,
31774,
31782,
31785,
31821,
31822,
31823,
31824,
31825,
31826,
31827,
31828,
31830,
31831,
31832,
31847,
31886,
31895,
31978,
32119,
32133,
32139,
32143,
32154,
32155,
32181,
32182,
32183,
32184,
32185,
32186,
32196,
32237,
32268,
32278,
32296,
32307,
32309,
32310,
32316,
32317,
32320,
32324,
32325,
32330,
32331,
32335,
32336,
32337,
32338,
32344,
32371,
32383,
32392,
32394,
32399,
32403,
32404,
32405,
32406,
32426,
32460,
32474,
32476,
32493,
32505,
32506,
32555,
32571,
32589,
32590,
32591,
32592,
32593,
32594,
32595,
32596,
32599,
32628,
32640,
32641,
32655,
32728,
32729,
32730,
32731,
32732,
32733,
32805,
32806,
32807,
32808,
32810,
32812,
32813,
32814,
32815,
32816,
32826,
32861,
32867,
32870,
32871,
33087,
33088,
33098,
33100,
33105,
33138,
35372,
35398,
35045,
34878,
34858,
34837,
34815,
34598,
33530,
33400,
33706,
36701,
35668,
35510,
35393,
35331,
35330,
35235,
35171,
35144,
34962,
34894,
34891,
34890,
34889,
34888,
34887,
34881,
34874,
34866,
34860,
34855,
34840,
34830,
34814,
34746,
34216,
33815,
33730,
33731,
33800,
33807,
34451,
35010,
35040,
35136,
35231,
35232,
35704,
35702,
35671,
35659,
35633,
35632,
35482,
35460,
35397,
35396,
35395,
35386,
35339,
35333,
35317,
35295,
35293,
35276,
35275,
35271,
35265,
35257,
35226,
35209,
35169,
35167,
35151,
35145,
35129,
35128,
35102,
35097,
35090,
35086,
35083,
35061,
35026,
35024,
35023,
35022,
35016,
35009,
35001,
34971,
34965,
34963,
34958,
34956,
34943,
34942,
34941,
34938,
34932,
34908,
34893,
34811,
34810,
34809,
34808,
34805,
34789,
34787,
34785,
34775,
34712,
34678,
34675,
34666,
34665,
34664,
34663,
34662,
34646,
34637,
34636,
34635,
34632,
34587,
34516,
34515,
34514,
34512,
34472,
34461,
34437,
34436,
34423,
34402,
34271,
34264,
34209,
34099,
34098,
34073,
34067,
34066,
34035,
34028,
33808,
33784,
33765,
33735,
33722,
33694,
33663,
33662,
33548,
33546,
33543,
33533,
33463,
33461,
33075,
33072,
33062,
33059,
32993,
32991,
32796,
32794,
32792,
32783,
32990,
33150,
33352,
33359,
35707,
35708,
35837,
35838,
35843,
35844,
35870,
35907,
35915,
35921,
35922,
36085,
36095,
36183,
36206,
36238,
36260,
36272,
36274,
36275,
36285,
36292,
36307,
36344,
36346,
36384,
36423,
36432,
36438,
36439,
36443,
36469,
36499,
36567,
36592,
36614,
36615,
36626,
36632,
36649,
36667,
36669,
36670,
36671,
36672,
36674,
36675,
36676,
36677,
36678,
36679,
36680,
36687,
36688,
36690,
36691,
36692,
36693,
36694,
36696,
36697,
36698,
36699,
36705,
36707,
36881,
37044,
37091,
37289,
37318,
37567,
36681,
32983,
32984,
32985,
33264,
33380,
33381,
33395,
33407,
34015,
34029,
34030,
34141,
34181,
34288,
34289,
34318,
34319,
34355,
34362,
34381,
34410,
34450,
34474,
34689,
34693,
34735,
35195,
35230,
35256,
35387,
35388,
35389,
35390,
35391,
35392,
35700,
35736,
35737,
35945,
36161,
36162,
36242,
36248,
36315,
36497,
36572,
36648,
36683,
36684,
36685,
36695,
36700,
36889,
36955,
37140,
37204,
37523,
37524,
37788,
37834,
37837,
37881,
37910,
37911,
37973,
37976,
37981,
38176,
38177,
38178,
38179,
38180,
38181,
38182,
38183,
38184,
38185,
38186,
38187,
38189,
38190,
38191,
38192,
38193,
38195,
38196,
38197,
38198,
38199,
38200,
38201);

UPDATE 
  quest_template 
SET
  flags = flags & ~0x10000,
  flags = flags | 0x100000 
WHERE id IN (
186,
187,
191,
192,
195,
196,
867,
869,
875,
2801,
12641,
12711,
12718,
12739,
12849,
13166,
13599,
14038,
14046,
14066,
14129,
14133,
14134,
14135,
14146,
14191,
14193,
14196,
14215,
14223,
14268,
14323,
14329,
14344,
14360,
14389,
14390,
24577,
24591,
24706,
25047,
25419,
25474,
25532,
25533,
25558,
25657,
25659,
25883,
25884,
26128,
26144,
26149,
26154,
26256,
26258,
26261,
26426,
26512,
26514,
26544,
26551,
26552,
26553,
26554,
26571,
26646,
26662,
26663,
26664,
26810,
26811,
26812,
26813,
26851,
26875,
26937,
27007,
27010,
27040,
27041,
27095,
27097,
27100,
27102,
27152,
27153,
27154,
27187,
27193,
27349,
27364,
27401,
27453,
27482,
27498,
27499,
27502,
27503,
27513,
27574,
27575,
27590,
27627,
27632,
27672,
27674,
27677,
27679,
27680,
27692,
27697,
27698,
27704,
27705,
27756,
27758,
27768,
27770,
27773,
27781,
27785,
27793,
27829,
27830,
27831,
27842,
27848,
27887,
27894,
27895,
27896,
27934,
27940,
27950,
27995,
28041,
28044,
28062,
28129,
28131,
28153,
28219,
28220,
28221,
28222,
28224,
28228,
28229,
28246,
28252,
28261,
28279,
28434,
28435,
28440,
28566,
28637,
28640,
28641,
28643,
28644,
28645,
28646,
28719,
28735,
28775,
28776,
28777,
28778,
28815,
28839,
28899,
29057,
29170,
29171,
29303,
29310,
29441,
29657,
29658,
29659,
29660,
29667,
29669,
29675,
29681,
29712,
29718,
29732,
29743,
29744,
29745,
29746,
29747,
29748,
29825,
29826,
29851,
29853,
29878,
29924,
29969,
29970,
30053,
30057,
30122,
30237,
30244,
30245,
30246,
30281,
30343,
30346,
30358,
30362,
30364,
30377,
30378,
30454,
30455,
30597,
30623,
30652,
30657,
30674,
30675,
30691,
30710,
30714,
30744,
30825,
30910,
30918,
30986,
30990,
31009,
31027,
31206,
31612,
31664,
31816,
31887,
31891,
31893,
31902,
31915,
31919,
31921,
31927,
31929,
31930,
31940,
31966,
32281,
32317,
32324,
32339,
32340,
32341,
32364,
32375,
32377,
32507,
32549,
32642,
32645,
32647,
32649,
32653,
32658,
32942,
32944,
33107,
33358,
34309,
33906,
34499,
36015,
36019,
37640,
35703,
35701,
35604,
35592,
35571,
35057,
35032,
34659,
34582,
34393,
34343,
34327,
34269,
34268,
34074,
33931,
33786,
33746,
33496,
33330,
33224,
33155,
33130,
33129,
33067,
33015,
33012,
32800,
32936,
32934,
33108,
33263,
35952,
35965,
35966,
35967,
35968,
35971,
35975,
35979,
35980,
35981,
35982,
35984,
36001,
36003,
36425,
36430,
36520,
36710,
36712,
36713,
36714,
36715,
36716,
36717,
36718,
36720,
36721,
36722,
36723,
36725,
36726,
36727,
36728,
36729,
36730,
36731,
36732,
36733,
36734,
36735,
36736,
36737,
36738,
36739,
36740,
36746,
36748,
36749,
36756,
36760,
36765,
36767,
36768,
36769,
36772,
36777,
36780,
36781,
36782,
36783,
36784,
36787,
36789,
37295,
37297,
37299,
37475,
37476,
37477,
37478,
37479,
37480,
37481,
37482,
37515,
34360,
34454,
34506,
34677,
35935,
36261,
36655,
36743,
36744,
36745,
36747,
36750,
36751,
36752,
36753,
36754,
36755,
36757,
36758,
36759,
36761,
36762,
36763,
36764,
36766,
36770,
36771,
36773,
36774,
36775,
36776,
36778,
36779,
36859,
37298,
37916,
37917,
37918,
37942,
37943,
37944,
38408,
38427,
38929,
38927);

-- Greenfire Questline fix

UPDATE quest_template SET flags =0x080000 WHERE id = 32307;
UPDATE quest_template SET flags =0x080000 WHERE id = 32309;
UPDATE quest_template SET flags =0x080000 WHERE id = 32310;
UPDATE quest_template SET flags =0x090000 WHERE id = 32317;
UPDATE quest_template SET flags =0x090000 WHERE id = 32324;
UPDATE quest_template SET flags =0x080000 WHERE id = 32325;

DELETE FROM creature_questender WHERE quest IN (32295,
32307,
32310,
32309,
32317,
32324,
32325);
DELETE FROM creature_queststarter WHERE quest IN (32295,
32307,
32310,
32309,
32317,
32324,
32325);
INSERT INTO creature_queststarter VALUE (88705, 32307);
INSERT INTO creature_queststarter VALUE (5496, 32307);
INSERT INTO creature_queststarter VALUE (88705, 32309);
INSERT INTO creature_queststarter VALUE (5496, 32310);
INSERT INTO creature_queststarter VALUE (88705, 32317);
INSERT INTO creature_queststarter VALUE (5496, 32317);
INSERT INTO creature_queststarter VALUE (88705, 32324);
INSERT INTO creature_queststarter VALUE (5496, 32324);
INSERT INTO creature_queststarter VALUE (88705, 32325);
INSERT INTO creature_queststarter VALUE (5496, 32325);
INSERT INTO creature_questender VALUE (88705, 32307);
INSERT INTO creature_questender VALUE (5496, 32307);
INSERT INTO creature_questender VALUE (88705, 32309);
INSERT INTO creature_questender VALUE (5496, 32310);
INSERT INTO creature_questender VALUE (70270, 32325);

-- =========================================================
-- =========================================================
-- =========================================================

-- PIG ALERT
-- PIG ALERT

DELIMITER @@

CREATE PROCEDURE `Test3`(IN `p_NextQuestID` INT, IN `p_NPCID` INT, OUT `p_Boule` BOOL)

BEGIN
	DECLARE done INT DEFAULT FALSE;
	DECLARE l_ResultItr INT;
	DECLARE l_ResultCursor CURSOR FOR SELECT id FROM creature_queststarter WHERE quest = p_NextQuestID;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

	OPEN l_ResultCursor;
	
	read_loop: LOOP
		FETCH l_ResultCursor INTO l_ResultItr;
		
		IF done THEN
			LEAVE read_loop;
		END IF;
		
		IF l_ResultItr = p_NPCID THEN
			SET p_Boule = TRUE;
		END IF;
		
	END LOOP;

	CLOSE l_ResultCursor;
	
END @@
DELIMITER ;

-- =========================================================
-- =========================================================
-- =========================================================

DELIMITER @@

CREATE PROCEDURE `Test2`(IN `p_QuestID` INT, IN `p_NextQuestID` INT, OUT `p_Boule` BOOL)

BEGIN
	DECLARE done INT DEFAULT FALSE;
	DECLARE l_ResultItr INT;
	DECLARE l_ResultCursor CURSOR FOR SELECT id FROM creature_questender WHERE quest = p_QuestID;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

	OPEN l_ResultCursor;
	
	read_loop: LOOP
		FETCH l_ResultCursor INTO l_ResultItr;
		
		IF done THEN
			LEAVE read_loop;
		END IF;
		
		CALL `Test3`(p_NextQuestID, l_ResultItr, @testbool);
		
		SET p_Boule = @testbool;
	END LOOP;

	CLOSE l_ResultCursor;
	
END @@
DELIMITER ;

-- =========================================================
-- =========================================================
-- =========================================================

DELIMITER @@

CREATE PROCEDURE `Test`()
BEGIN
	
	DECLARE done INT DEFAULT FALSE;
	DECLARE l_Quest, l_NextQuest INT;
	DECLARE l_ResultCursor CURSOR FOR SELECT id, nextquestidchain FROM quest_template WHERE id IN (SELECT NextQuestIdChain FROM quest_template WHERE NextQuestIdChain != 0 AND ExclusiveGroup = 0 AND NOT flags & 0x00200000) AND ExclusiveGroup = 0;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

	OPEN l_ResultCursor;
	
	read_loop: LOOP
		FETCH l_ResultCursor INTO l_Quest, l_NextQuest;
		IF done THEN
			LEAVE read_loop;
		END IF;
		
		CALL `Test2`(l_Quest, l_NextQuest, @booltest);
		
		IF (@booltest = TRUE) THEN
			UPDATE quest_template SET flags = flags | 0x00200000 WHERE id = l_NextQuest;
		END IF;
	END LOOP;

	CLOSE l_ResultCursor;
	
END @@
DELIMITER ;

CALL `Test`();
	
DROP PROCEDURE `Test`;
DROP PROCEDURE `Test2`;
DROP PROCEDURE `Test3`;



-- =========================================================
-- =========================================================
-- =========================================================

-- END ALERT
-- GL HF